<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>LangChain + 本地ChatGLM3模型构建Agent（一）工具调用的底层逻辑和测试 | eternal-bug的博客</title><meta name="author" content="eternal-bug"><meta name="copyright" content="eternal-bug"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Agent是什么 Agent 是具备通过独立思考、调用工具去逐步完成给定目标的智能工具。国内举例子最常见的就是点外卖Agent🤣：告诉 Agent 帮忙下单一份炸鸡的外卖，它就可以根据你的习惯和消费水平直接调用 APP 筛选合适的外卖，再调用支付程序下单支付，无需人类去指定每一步的操作。这与之前的比如小度小度关灯啊、放音乐啊、关窗帘的工具不同，Agent涉及到更为复杂的过程。  关于Agent网">
<meta property="og:type" content="article">
<meta property="og:title" content="LangChain + 本地ChatGLM3模型构建Agent（一）工具调用的底层逻辑和测试">
<meta property="og:url" content="https://eternal-bug.github.io/posts/91e29fb3.html">
<meta property="og:site_name" content="eternal-bug的博客">
<meta property="og:description" content="Agent是什么 Agent 是具备通过独立思考、调用工具去逐步完成给定目标的智能工具。国内举例子最常见的就是点外卖Agent🤣：告诉 Agent 帮忙下单一份炸鸡的外卖，它就可以根据你的习惯和消费水平直接调用 APP 筛选合适的外卖，再调用支付程序下单支付，无需人类去指定每一步的操作。这与之前的比如小度小度关灯啊、放音乐啊、关窗帘的工具不同，Agent涉及到更为复杂的过程。  关于Agent网">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://eternal-bug.github.io/img/avatar.png">
<meta property="article:published_time" content="2024-06-25T13:06:07.000Z">
<meta property="article:modified_time" content="2024-07-17T12:34:13.911Z">
<meta property="article:author" content="eternal-bug">
<meta property="article:tag" content="LangChain">
<meta property="article:tag" content="ChatGLM3">
<meta property="article:tag" content="Agent">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://eternal-bug.github.io/img/avatar.png"><link rel="shortcut icon" href="/img/bug1.png"><link rel="canonical" href="https://eternal-bug.github.io/posts/91e29fb3.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'LangChain + 本地ChatGLM3模型构建Agent（一）工具调用的底层逻辑和测试',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-17 20:34:13'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="eternal-bug的博客" type="application/atom+xml">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-timeline"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-layer-group"></i><span> 分类</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/Perl/"><i class="fa-fw fas fa-code"></i><span> Perl</span></a></li><li><a class="site-page child" href="/categories/Python/"><i class="fa-fw fas fa-code"></i><span> Python</span></a></li><li><a class="site-page child" href="/categories/R/"><i class="fa-fw fas fa-code"></i><span> R</span></a></li><li><a class="site-page child" href="/categories/%E5%8D%9A%E5%AE%A2/"><i class="fa-fw fas fa-blog"></i><span> 博客</span></a></li><li><a class="site-page child" href="/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B/"><i class="fa-fw fas fa-microchip"></i><span> 大模型</span></a></li><li><a class="site-page child" href="/categories/%E8%AE%BE%E8%AE%A1/"><i class="fa-fw fas fa-pen-ruler"></i><span> 设计</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/statistics/"><i class="fa-fw fas fa-chart-simple"></i><span> 统计</span></a></li><li><a class="site-page child" href="/bioinformatics/"><i class="fa-fw fas fa-dna"></i><span> 生信</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-sliders"></i><span> 多媒体</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/game/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/starbound.half.png')"><nav id="nav"><span id="blog-info"><a href="/" title="eternal-bug的博客"><span class="site-name">eternal-bug的博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-timeline"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-layer-group"></i><span> 分类</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/Perl/"><i class="fa-fw fas fa-code"></i><span> Perl</span></a></li><li><a class="site-page child" href="/categories/Python/"><i class="fa-fw fas fa-code"></i><span> Python</span></a></li><li><a class="site-page child" href="/categories/R/"><i class="fa-fw fas fa-code"></i><span> R</span></a></li><li><a class="site-page child" href="/categories/%E5%8D%9A%E5%AE%A2/"><i class="fa-fw fas fa-blog"></i><span> 博客</span></a></li><li><a class="site-page child" href="/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B/"><i class="fa-fw fas fa-microchip"></i><span> 大模型</span></a></li><li><a class="site-page child" href="/categories/%E8%AE%BE%E8%AE%A1/"><i class="fa-fw fas fa-pen-ruler"></i><span> 设计</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/statistics/"><i class="fa-fw fas fa-chart-simple"></i><span> 统计</span></a></li><li><a class="site-page child" href="/bioinformatics/"><i class="fa-fw fas fa-dna"></i><span> 生信</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-sliders"></i><span> 多媒体</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/game/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">LangChain + 本地ChatGLM3模型构建Agent（一）工具调用的底层逻辑和测试</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-25T13:06:07.000Z" title="发表于 2024-06-25 21:06:07">2024-06-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-17T12:34:13.911Z" title="更新于 2024-07-17 20:34:13">2024-07-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B/">大模型</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>24分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="LangChain + 本地ChatGLM3模型构建Agent（一）工具调用的底层逻辑和测试"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="Agent是什么">Agent是什么</h2>
<p>Agent 是具备通过独立思考、调用工具去逐步完成给定目标的智能工具。国内举例子最常见的就是点外卖Agent🤣：告诉 Agent 帮忙下单一份炸鸡的外卖，它就可以根据你的习惯和消费水平直接调用 APP 筛选合适的外卖，再调用支付程序下单支付，无需人类去指定每一步的操作。这与之前的比如小度小度关灯啊、放音乐啊、关窗帘的工具不同，Agent涉及到更为复杂的过程。</p>
<p><img src="/posts/91e29fb3/%E8%85%BE%E8%AE%AF%E7%A0%94%E7%A9%B6%E9%99%A2Agent%E6%A1%86%E6%9E%B6.png" alt="Agent框架"></p>
<p>关于Agent网上有铺天盖地的新闻我就不多说了。其中工具调用（function call）就是非常关键的一环。</p>
<p>大语言模型算算术常常出错，让它去用一个计算器是不是很合理？</p>
<h2 id="计算器">计算器</h2>
<p>在文章最开头，先来问一个问题：大语言模型已知只能接受文本而且只能输出文本，怎么样让它去用计算器呢？</p>
<p><img src="/posts/91e29fb3/%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E7%9A%84%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA.jpg" alt="大语言模型的输入输出"></p>
<p>如果按照python代码函数调用的方式，为什么输出了文本能去调用函数（function call）呢？就像通感了一样：</p>
<div style="font-size: 20px; color: transparent; background: linear-gradient(to right, red, #d5257c, green, #1e8025);   background-clip: text; /* 将背景应用于文本 */   -webkit-background-clip: text; /* 针对webkit浏览器的前缀 */   -webkit-text-fill-color: transparent; /* 针对webkit浏览器的透明文本 */   text-align: center;   margin: 0px; "> <strong>微风过处，送来缕缕清香，仿佛远处高楼上渺茫的歌声似的。 </strong></div>
<p>又或者说让我不动手脚只动嘴说话去控制计算器一样（🤔如果真的能打嘴炮利用空气波也许能按动计算器吧😏）。</p>
<hr>
<h2 id="文本是什么">文本是什么</h2>
<p>在ChatGPT出来后的一段时间内，我一直用来它聊天摸鱼、顺带把活儿干了感觉挺好，它是一个很聪明的，有逻辑的”对话工具“，对我来说仅此而已。然而就在它掀起人工智能新浪潮的背后，更为智能的机器人项目也在萌生，比如特斯拉的<em>Optimus</em>、OpenAI的<em>Figure01</em>，这些机器人可以很快理解人的指令并执行动作，比如拿起桌子上的苹果，而且具有学习能力具有计划，有人说这么快的响应速度很可能不仅仅是因为大语言模型，具体细节我不是太清楚就不多说了。我想强调的是当我看到关于它们的新闻时不太能将”对话工具“和“实体机械臂”之间关联起来，如果是做一个没有实体的、类似于电影《Her》里面情感聊天机器人，这我是能理解的。中间一段时间没有深入了解，也就不了了之了，后来在B站偶然看到一个现在看起来很普通的评论说：“大语言模型可以返回json”，那会儿我瞬间就想明白了，文本不仅仅只是我们现在平常生活中说的这种语言，语言能够承载信息，对信息进行进一步的处理就能完成上面的事。</p>
<p>从此我开始意识到之前对“文本”的定义过于狭隘，实际上我们人很多的事情都可以通过以文本的形式写出来：比如用诗歌表达自己的所见所闻所感；用记叙文记录旅游的过程；用数学公式记录思维逻辑推导；编写代码自动化批量下载文件；写下制作沙瓶子画所需要的步骤等等。这里面的<mark class="hl-label green">诗歌</mark> 、<mark class="hl-label green">记叙文</mark> 、<mark class="hl-label green">数学公式</mark> 、<mark class="hl-label green">代码</mark> 、<mark class="hl-label green">步骤</mark> 都是<mark class="hl-label pink">文本</mark> 。更加详细点，文本还包括：<mark class="hl-label green">json</mark> 、<mark class="hl-label green">markdown</mark> 、<mark class="hl-label green">docx</mark> 、<mark class="hl-label green">excel</mark> 、<mark class="hl-label green">ppt</mark> 、<mark class="hl-label green">pdf</mark> 里面的文字内容。最需要强调的是<code>json</code>，因为这是<strong>不同程序之间交流信息最为常见的格式</strong>，特别是网站API，这也是前后端经常吵架的聚焦点😓（前端和后端可能会因为数据格式、字段约定、API设计等问题互怼），<a href="https://eternal-bug.github.io/posts/ae6567a8.html">上一篇文章</a>中提到的OpenAI的标准就是传输的<code>json</code>。</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"北京"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"坐标"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"116E"</span><span class="punctuation">,</span> <span class="string">"40N"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"别名"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"北平"</span>、<span class="string">"燕京"</span>、<span class="string">"蓟"</span>、<span class="string">"幽州"</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"上海"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"坐标"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"121E"</span><span class="punctuation">,</span> <span class="string">"31N"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"别名"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"申城"</span><span class="punctuation">,</span> <span class="string">"魔都"</span><span class="punctuation">,</span> <span class="string">"上海滩"</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"南京"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"坐标"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"118E"</span><span class="punctuation">,</span> <span class="string">"31N"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"别名"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"金陵"</span><span class="punctuation">,</span> <span class="string">"建康"</span><span class="punctuation">,</span> <span class="string">"应天"</span><span class="punctuation">,</span> <span class="string">"天京"</span><span class="punctuation">,</span> <span class="string">"徽京"</span><span class="punctuation">,</span> <span class="string">"江苏人的萨拉热窝"</span><span class="punctuation">,</span> <span class="string">"台湾人的耶路撒冷"</span><span class="punctuation">,</span> <span class="string">"安徽人的柯尼斯堡"</span><span class="punctuation">,</span> <span class="string">"鸭子们的奥斯维辛"</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">	...</span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>
<p>这就是<code>json</code>，一种有结构的、规则的、信息密集的格式，因为本身数据的组织方式就携带了信息，这个比用一段文字去描述会更加有效，也更加方便程序去读取。除了json之外也还有其他很多的格式。</p>
<div class="note primary simple"><p><strong>题外话</strong></p>
<p>据说中文的信息密度要比外文高很多，也就是压缩率很高，成语被人说是压缩包，举个例子，“杯水车薪”，中国人脑袋自带极为优异的解压器，而老外必须再装个解压效率一般的解压器。再比如说为什么弹幕文化我们亚洲的发展更加好，因为信息压缩比例高，在相同长度的显示下，中文、日文等能够包含更多信息，而携带相同信息的英文就需要更长的显示，弹幕本来就是实时交流的，不能过长，欧美都是在侧面的的滚动聊天记录，这和弹幕有着天壤之别。</p>
<p>但是，与直觉相反，相同的请求，用中文消耗的token竟然多于英文，暂时没有想明白为什么。</p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/37998688/answer/489871504">世界上信息熵最大的语言是汉语吗？</a><br>
<a target="_blank" rel="noopener" href="https://persquaremile.com/2011/12/21/which-reads-faster-chinese-or-english/?continueFlag=6f9d812dec9c5a8baf91a7d4240b7252">Which reads faster, Chinese or English?</a></p>
</div>
<p>大语言模型可以输入和输出<strong>有格式的，有规则的</strong>文本之后，那就能回答说我具体想要做什么呢，以及怎么做，有哪些细节，比如说问它一下应该怎么做一道番茄炒蛋：</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">首先eternal-bug你要去菜市场买或者自家小院准备</span><br><span class="line">菜单：</span><br><span class="line">  - 番茄</span><br><span class="line">    - 数量：2个</span><br><span class="line">    - 色泽：鲜红色</span><br><span class="line">  - 鸡蛋</span><br><span class="line">    - 数量：2个</span><br><span class="line">    - 色泽：微黄色泛红</span><br><span class="line"></span><br><span class="line">步骤：</span><br><span class="line">  - 取两三个鸡蛋，打匀，放上少许盐，备用</span><br><span class="line">  - 番茄切片放在盘子备用</span><br><span class="line">  - 起锅烧油，油不能太热</span><br><span class="line">  - 倒入混匀的鸡蛋翻炒</span><br><span class="line">  - 炒自略微发黄的取出放在盘子里备用</span><br><span class="line">  - 烧油，油不能太热</span><br><span class="line">  - 倒入番茄番茄</span><br><span class="line">  - 倒入超过的鸡蛋翻炒</span><br><span class="line">  - 出锅</span><br></pre></td></tr></tbody></table></figure>
<p>按照这样有条理的“文本”，通过大语言模型来完成工具调用也就有可能了：大语言模型就是负责想，负责计划，负责使唤就行了。</p>
<p>你可能想到点儿什么…，这不是我老公吗，这不是我老婆吗，这不是我女朋友吗？</p>
<div class="note danger simple"><p>“<a href="https://eternal-bug.github.io/">eternal-bug</a>，我不想动，你去帮我把充电器拿来。算了算了，充电器线不够，找找充电宝！”<br>
“哎呀！<a href="https://eternal-bug.github.io/">eternal-bug</a>你成天没事儿做是吧，还打王者荣耀，做饭去！家里都揭不开锅了！打打打就知道打游戏，这一天天的！”<br>
”喏，这是今天需要买的菜，我都写纸条上了，别忘了，少一样今天没你的饭吃！“。</p>
</div>
<p><img src="/posts/91e29fb3/%E8%80%81%E5%A9%86%E7%94%9F%E6%B0%94.gif" alt="老婆生气"></p>
<p>😏你女朋友还是你的，我只是举个例子，希望以后的人工智能不要这样🤪。</p>
<p>具体是怎么实现的呢？在此之前我还得像老太婆一样唠叨一句：<strong>大语言模型的输入和输出只能是文本</strong>。具体说是文本的token id：</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">文本 -&gt; token ids -&gt; 大语言模型 -&gt; token ids -&gt; 文本</span><br></pre></td></tr></tbody></table></figure>
<h2 id="抽丝剥茧">抽丝剥茧</h2>
<p>如果本地没有部署ChatGLM3模型，可以先按照我<a href="https://eternal-bug.github.io/posts/ae6567a8.html">上一篇文章</a>进行本地部署。</p>
<p>ChatGLM3这个项目比较贴心里面有很多代码，在执行项目的<code>tools_using_demo</code>文件夹下，有一个<code>cli_demo_tool.py</code>的代码，里面写了关于基本的<code>function call</code>的形式。其它的代码暂时忽略，主要关注第119行的：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response, history = model.chat(tokenizer, query, history=history, role=role)</span><br></pre></td></tr></tbody></table></figure>
<p>可以以此来确定进行<code>function call</code>需要输入哪些东西：</p>
<ul>
<li><code>tokenizer</code>：用来将句子转换为编号的模型。</li>
<li><code>query</code>：输入的问题或者信息。</li>
<li><code>history</code>：历史聊天记录。</li>
<li><code>role</code>：目前扮演的角色。</li>
</ul>
<div class="note info simple"><p><strong>token</strong></p>
<p>简单的说就是一句话里面的最小单元，比如中文里面的单个文字，通过给每一个文字和标点给上一个编号就叫做token id，方便计算机处理，<code>tokenizer</code>就是用来将文字进行转换的模型，比如（这里的token id是我瞎掰的，意思就是这个意思）：</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">我  -&gt;   10</span><br><span class="line">喜  -&gt;   234</span><br><span class="line">欢  -&gt;   546</span><br><span class="line">你  -&gt;   11</span><br></pre></td></tr></tbody></table></figure>
</div>
<p><code>chat</code>方法不是最为底层的方法，通常是基于模型生成的基础上自定义的功能，需要再进一步查看<code>chat</code>代码里面是什么，<code>transformers</code>库提供的是<strong>基本</strong>的模型和分词器接口，用于文本生成、分类等任务，其中最为基本的预测方法来源于<code>transformers.modeling_utils.PreTrainedModel</code>叫做<code>generate</code>。</p>
<p>在下载的模型权重<code>ZhipuAI/chatglm3-6b</code>文件夹里面有一个<code>modeling_chatglm.py</code>和<code>tokenization_chatglm.py</code>文件，它里面有模型<code>chat</code>方法和<code>tokenizer</code>字符串拼接的方法。这就是了解到底层原理的关键。（这样的脚本文件并不出现在早期不支持工具调用的<code>ZhipuAI/chatglm-6b</code>模型中）。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">chat</span>(<span class="params">self, tokenizer, query: <span class="built_in">str</span>, history: <span class="type">List</span>[<span class="type">Dict</span>] = <span class="literal">None</span>, role: <span class="built_in">str</span> = <span class="string">"user"</span>,</span></span><br><span class="line"><span class="params">         max_length: <span class="built_in">int</span> = <span class="number">8192</span>, num_beams=<span class="number">1</span>, do_sample=<span class="literal">True</span>, top_p=<span class="number">0.8</span>, temperature=<span class="number">0.8</span>, logits_processor=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">         **kwargs</span>):</span><br><span class="line">    <span class="keyword">if</span> history <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        history = []</span><br><span class="line">    <span class="keyword">if</span> logits_processor <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        logits_processor = LogitsProcessorList()</span><br><span class="line">    logits_processor.append(InvalidScoreLogitsProcessor())</span><br><span class="line">    <span class="comment"># generate的参数</span></span><br><span class="line">    gen_kwargs = {<span class="string">"max_length"</span>: max_length, <span class="string">"num_beams"</span>: num_beams, <span class="string">"do_sample"</span>: do_sample, <span class="string">"top_p"</span>: top_p,</span><br><span class="line">                    <span class="string">"temperature"</span>: temperature, <span class="string">"logits_processor"</span>: logits_processor, **kwargs}</span><br><span class="line">    <span class="comment"># 关键点：使用tokenizer将query、history、role转换为token id</span></span><br><span class="line">    inputs = tokenizer.build_chat_input(query, history=history, role=role)</span><br><span class="line">    inputs = inputs.to(self.device)</span><br><span class="line">    eos_token_id = [tokenizer.eos_token_id, tokenizer.get_command(<span class="string">"&lt;|user|&gt;"</span>),</span><br><span class="line">                    tokenizer.get_command(<span class="string">"&lt;|observation|&gt;"</span>)]</span><br><span class="line">    <span class="comment"># 使用最底层的generate方法</span></span><br><span class="line">    <span class="comment"># [ token id a, token id b , token id c, ...] =&gt; self.generate =&gt; [token id x , token id y, token id z, ...]</span></span><br><span class="line">    outputs = self.generate(**inputs, **gen_kwargs, eos_token_id=eos_token_id)</span><br><span class="line">    outputs = outputs.tolist()[<span class="number">0</span>][<span class="built_in">len</span>(inputs[<span class="string">"input_ids"</span>][<span class="number">0</span>]):-<span class="number">1</span>]</span><br><span class="line">    <span class="comment"># 查阅token id和字符的对应关系，转换为文本</span></span><br><span class="line">    response = tokenizer.decode(outputs)</span><br><span class="line">    <span class="comment"># 添加一下对话信息到history</span></span><br><span class="line">    history.append({<span class="string">"role"</span>: role, <span class="string">"content"</span>: query})</span><br><span class="line">    <span class="comment"># 解析结果</span></span><br><span class="line">    response, history = self.process_response(response, history)</span><br><span class="line">    <span class="keyword">return</span> response, history</span><br></pre></td></tr></tbody></table></figure>
<p>这里进一步看<code>build_chat_input()</code>方法：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">build_chat_input</span>(<span class="params">self, query, history=<span class="literal">None</span>, role=<span class="string">"user"</span></span>):</span><br><span class="line">    <span class="keyword">if</span> history <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        history = []</span><br><span class="line">    input_ids = []</span><br><span class="line">    <span class="comment"># (1)</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> history:</span><br><span class="line">        content = item[<span class="string">"content"</span>]</span><br><span class="line">        <span class="keyword">if</span> item[<span class="string">"role"</span>] == <span class="string">"system"</span> <span class="keyword">and</span> <span class="string">"tools"</span> <span class="keyword">in</span> item:</span><br><span class="line">            content = content + <span class="string">"\n"</span> + json.dumps(item[<span class="string">"tools"</span>], indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        input_ids.extend(self.build_single_message(item[<span class="string">"role"</span>], item.get(<span class="string">"metadata"</span>, <span class="string">""</span>), content))</span><br><span class="line">    <span class="comment"># (2)</span></span><br><span class="line">    input_ids.extend(self.build_single_message(role, <span class="string">""</span>, query))</span><br><span class="line">    <span class="comment"># (3)</span></span><br><span class="line">    input_ids.extend([self.get_command(<span class="string">"&lt;|assistant|&gt;"</span>)])</span><br><span class="line">    <span class="comment"># (4)</span></span><br><span class="line">    <span class="keyword">return</span> self.batch_encode_plus([input_ids], return_tensors=<span class="string">"pt"</span>, is_split_into_words=<span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>这里主要做了几件事情：<br>
<strong>(1)</strong> 将history列表中的信息使用换行符<code>\n</code>把字符串拼接起来，在<code>role</code>是<code>system</code>的时候单独处理字符串因为（<code>system</code>指定的提示词一定是非常关键的和格式特殊的）。<br>
<strong>(2)</strong> 将现在最新的role和query字符串拼接起来。<br>
<strong>(3)</strong> 最后添加一个<code>&lt;|assistant|&gt;</code>的标记。<br>
<strong>(4)</strong> <code>batch_encode_plus</code>是transformers的内置方法，就是把数据转换为特定格式的数据，这不是这里的重点。</p>
<p>注意这里出现了个特殊标记<code>&lt;|assistant|&gt;</code>，除此之外，还有几个标记，在这个python文件中，一个名叫<code>SPTokenizer</code>的类下面，有一个列表：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">special_tokens = [<span class="string">"[MASK]"</span>, <span class="string">"[gMASK]"</span>, <span class="string">"[sMASK]"</span>, </span><br><span class="line">                  <span class="string">"sop"</span>, <span class="string">"eop"</span>, </span><br><span class="line">                  <span class="string">"&lt;|system|&gt;"</span>, <span class="string">"&lt;|user|&gt;"</span>, <span class="string">"&lt;|assistant|&gt;"</span>, <span class="string">"&lt;|observation|&gt;"</span>]</span><br></pre></td></tr></tbody></table></figure>
<p>前面几个标记是大语言模型常见的，比如<code>[MASK]</code>通常用于掩码语言模型（如 BERT，Transformer）中的掩码预测任务；<code>sop</code>通常表示句子的开头（start of passage）等等。</p>
<p>主要是最后4个<code>&lt;|system|&gt;</code>、<code>&lt;|user|&gt;</code>、<code>&lt;|assistant|&gt;</code>、<code>&lt;|observation|&gt;</code>。这揭示了大语言模型仅靠输入文本就能回复有规律的答案的秘密。这是一种特殊标记，看英文单词也能看出来：</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;|system|&gt;      系统  用来标记系统指令，一般在最开始就定义好的，比如说你现在需要扮演一名律师。</span><br><span class="line">&lt;|user|&gt;        用户  标记用户说的话。</span><br><span class="line">&lt;|assistant|&gt;   助理  标记模型回复的信息</span><br><span class="line">&lt;|observation|&gt; 观测  标记外部call function返回的数据。</span><br></pre></td></tr></tbody></table></figure>
<p>按照上面的<code>build_chat_input</code>的代码，好像在不停的拼接和role相关的角色和文本内容，这些角色的标记只有上面框中的四种，这是用来告诉模型看到这个标记就需要做不一样的动作。</p>
<p>相当于在训练一只狗子一样，在他的记忆中存在了这样的印记，<code>坐下</code>，<code>过来</code>，<code>握手</code>，<code>吃饭</code>：</p>
<p><img src="/posts/91e29fb3/%E7%8B%97%E5%AD%90%E6%8E%92%E9%98%9F%E6%89%93%E9%A5%AD.jpg" alt="狗子排队打饭"></p>
<p>这里的<code>&lt;|assistant|&gt;</code>这样的特殊标记就是模型被训练之后留在它记忆中的印记。</p>
<div class="note warning simple"><p>需要注意的是上面的字符串拼接并不是一次性先拼接好，类似于</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;|system|&gt;</span><br><span class="line">你现在需要扮演我的女友</span><br><span class="line"></span><br><span class="line">&lt;|user|&gt;</span><br><span class="line">你喜欢我吗？</span><br></pre></td></tr></tbody></table></figure>
<p>再一次性转换为token id（❌）。</p>
<p>而是特殊标记需要单独转换为相应token id（✅）：</p>
<p>token ids =[ <code>&lt;|system|&gt;</code>的token id ,  <code>你现在需要扮演我的女友</code>的token id,  <code>&lt;|user|&gt;</code>的token id,  <code>你喜欢我吗？</code>的token id]。</p>
<p>如果先把所有的字符串拼接好了再一次性转换为token id，可能会导致<code>&lt;|system|&gt;</code>不作为整体进行token转换，而是比如拆分为<code>&lt;</code>，<code>|</code>，<code>system</code>，<code>|</code>，<code>&gt;</code>字符分别转换。这样特殊标记就失效了，模型很可能会做出完全不同的回应。</p>
</div>
<p>特殊标记是为了让模型对内容进行区分。在官方文档中，有说明工具调用的过程（文档写的叫做思维链）和这些特殊标记的关系：</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;|system|&gt;</span><br><span class="line">给模型的指令和关于函数的描述</span><br><span class="line"></span><br><span class="line">&lt;|user|&gt;</span><br><span class="line">提出的问题</span><br><span class="line"></span><br><span class="line">&lt;|assistant|&gt;</span><br><span class="line">思考应该做什么</span><br><span class="line"></span><br><span class="line">&lt;|assistant|&gt;</span><br><span class="line">调用工具以及工具的参数</span><br><span class="line">toolname(参数)</span><br><span class="line"></span><br><span class="line">&lt;|observation|&gt;</span><br><span class="line">外部的function返回的结果</span><br><span class="line"></span><br><span class="line">&lt;|assistant|&gt;</span><br><span class="line">回复用户最后function执行的结果（如果没有返回结果模型并不会回复用户）</span><br></pre></td></tr></tbody></table></figure>
<p>和工具调用最为关键的是<code>&lt;|system|&gt;</code>标记后接上的函数描述，那应该怎么写函数的描述才能让模型告诉说你现在这个问题要调用哪个函数呢？这些函数有哪些参数需要设置呢？</p>
<p>是要定义一个特殊的文本，类似于下面的：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">{<span class="string">'content'</span>: <span class="string">'Answer the following questions as best as you can. You have access to the following tools:'</span>,</span><br><span class="line">  <span class="string">'role'</span>: <span class="string">'system'</span>,</span><br><span class="line">  <span class="string">'tools'</span>: [{<span class="string">'description'</span>: <span class="string">'查询对应城市的天气'</span>,</span><br><span class="line">             <span class="string">'name'</span>: <span class="string">'get_weather'</span>,</span><br><span class="line">             <span class="string">'parameters'</span>: {<span class="string">'properties'</span>: {<span class="string">'city'</span>: {<span class="string">'description'</span>: <span class="string">'需要查询天气的城市'</span>}},</span><br><span class="line">                            <span class="string">'required'</span>: [],</span><br><span class="line">                            <span class="string">'type'</span>: <span class="string">'object'</span>}},</span><br><span class="line">            {<span class="string">'description'</span>: <span class="string">'生成随机数'</span>,</span><br><span class="line">             <span class="string">'name'</span>: <span class="string">'generate_random_number'</span>,</span><br><span class="line">             <span class="string">'parameters'</span>: {<span class="string">'properties'</span>: {<span class="string">'min_v'</span>: {<span class="string">'description'</span>: <span class="string">'最小值'</span>},</span><br><span class="line">                                           <span class="string">'max_v'</span>: {<span class="string">'description'</span>: <span class="string">'最大值'</span>}},</span><br><span class="line">                            <span class="string">'required'</span>: [],</span><br><span class="line">                            <span class="string">'type'</span>: <span class="string">'object'</span>}}</span><br><span class="line">            ]</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>
<p>这是官方给出的一个示例就是json格式。首先是给模型一个指令说：「你要尽可能的回答问题，你可以去用下面这些工具」，第二部分就是关于函数的描述。这里<code>role</code>指定为<code>system</code>。</p>
<p>关于<code>tools</code>的定义，一个列表就是一个函数的具体描述，里面包含很多键值对，比如查看天气的函数<code>get_weather</code>：</p>
<ul>
<li><code>description</code>：该函数的描述。（模型通过对用户的提问的理解来判断是不是应该调用这个函数）</li>
<li><code>name</code>：函数的名称。</li>
<li><code>parameters</code>：函数具体参数的描述。
<ul>
<li><code>type</code>：参数类型。</li>
<li><code>required</code>：哪些参数是需要要填的。</li>
<li><code>properties</code>：具体的参数说明
<ul>
<li><code>city</code>：参数的名称。</li>
<li><code>{'description': '需要查询天气的城市'}</code>：这个参数的描述。（模型通过对用户的提问的理解来确定有没有设置这个参数）</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>除此之外，还有一些其他的设置，后续再给出。之所以要这么写，因为这是目前OpenAI的标准，模型就是这么训练的，后续使用它对于这种格式和组织方式识别和理解准确性更高。</p>
<p>下面写一下查询天气和生成随机数这两个函数：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询天气</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_weather</span>(<span class="params">city</span>):</span><br><span class="line">    <span class="comment"># 判断一下参数类型</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(city_name, <span class="built_in">str</span>):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"City name must be a string"</span>)</span><br><span class="line"></span><br><span class="line">    key_selection = {<span class="string">"current_condition"</span>: [<span class="string">"temp_C"</span>, <span class="string">"FeelsLikeC"</span>, <span class="string">"humidity"</span>, <span class="string">"weatherDesc"</span>, <span class="string">"observation_time"</span>]}</span><br><span class="line">    <span class="comment"># 使用https://wttr.in的网页API来得到当前城市的天气</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        resp = requests.get(<span class="string">f"https://wttr.in/<span class="subst">{city_name}</span>?format=j1"</span>)</span><br><span class="line">        resp.raise_for_status()</span><br><span class="line">        <span class="comment"># 转换为json</span></span><br><span class="line">        resp = resp.json()</span><br><span class="line">        <span class="comment"># 获取特定的字段的值</span></span><br><span class="line">        ret = {k: {_v: resp[k][<span class="number">0</span>][_v] <span class="keyword">for</span> _v <span class="keyword">in</span> v} <span class="keyword">for</span> k, v <span class="keyword">in</span> key_selection.items()}</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        ret = <span class="string">"Error encountered while fetching weather data!\n"</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 特定的用str函数转换为字符串类型</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(ret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成随机数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_random_number</span>(<span class="params">min_v, max_v</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(min_v, (<span class="built_in">int</span>, <span class="built_in">float</span>)):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"min_v must be an integer"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(max_v, (<span class="built_in">int</span>, <span class="built_in">float</span>)):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"max_v must be an integer"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(random.randint(min_v, max_v))</span><br></pre></td></tr></tbody></table></figure>
<p>需要注意是：</p>
<p><strong>(1)</strong> ChatGLM3返回的只是文本，后面调用函数是通过文本解析出来，参数的类型或者范围有可能不对，所以需要对参数类型或者范围进行判断以免导致函数执行失效。<br>
<strong>(2)</strong> 返回的结果转换为字符串类型，因为后续模型需要转换为token id。</p>
<div class="note primary simple"><p><strong>小技巧</strong></p>
<p>其实函数不一定需要真正的执行，在测试阶段，可以写一个伪函数（dummy function），假装执行了函数：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 比如生成随机数的伪函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_random_number</span>(<span class="params">min_v, max_v</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>
<p>这个技巧在一些比较花费时间的函数上是很有用的。</p>
</div>
<p>有了函数和函数描述后，就给模型装只手臂🦾，它分析问题下发指令让机械手去执行任务（执行函数）。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 函数以字典的形式保存，方便去使用字符串名称去调取函数它本身</span></span><br><span class="line"><span class="comment"># 比如 function_mapping["get_weather"] 就和 get_weather 是一样的</span></span><br><span class="line">function_mapping = {</span><br><span class="line">    <span class="string">'get_weather'</span>: get_weather,</span><br><span class="line">    <span class="string">'generate_random_number'</span>: generate_random_number,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">function_call</span>(<span class="params">response</span>):</span><br><span class="line">    function_name = response[<span class="string">'name'</span>]</span><br><span class="line">    parameters = response[<span class="string">'parameters'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 调用相应的函数</span></span><br><span class="line">    <span class="keyword">if</span> function_name <span class="keyword">in</span> function_mapping:</span><br><span class="line">        <span class="comment"># function_mapping[function_name]就找到对应的函数本身</span></span><br><span class="line">        <span class="comment"># **parameters解开字典</span></span><br><span class="line">        <span class="comment">#   {"city": "上海"} -&gt; city="上海"</span></span><br><span class="line">        <span class="comment"># result = get_weather(city="上海")</span></span><br><span class="line">        result = function_mapping[function_name](**parameters)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span>(<span class="string">"Function '{function_name}' not found."</span>.<span class="built_in">format</span>(function_name))</span><br></pre></td></tr></tbody></table></figure>
<p>这里所有的代码已经有了，参照官方给的代码，完整的代码为：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoTokenizer, AutoModel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取城市天气</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_weather</span>(<span class="params">city</span>):</span><br><span class="line">    <span class="comment"># 判断一下参数类型</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(city, <span class="built_in">str</span>):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"City name must be a string"</span>)</span><br><span class="line"></span><br><span class="line">    key_selection = {<span class="string">"current_condition"</span>: [<span class="string">"temp_C"</span>, <span class="string">"FeelsLikeC"</span>, <span class="string">"humidity"</span>, <span class="string">"weatherDesc"</span>, <span class="string">"observation_time"</span>]}</span><br><span class="line">    <span class="comment"># 使用https://wttr.in的网页API来得到当前城市的天气</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        resp = requests.get(<span class="string">f"https://wttr.in/<span class="subst">{city}</span>?format=j1"</span>)</span><br><span class="line">        resp.raise_for_status()</span><br><span class="line">        <span class="comment"># 转换为json</span></span><br><span class="line">        resp = resp.json()</span><br><span class="line">        <span class="comment"># 获取特定的字段的值</span></span><br><span class="line">        ret = {k: {_v: resp[k][<span class="number">0</span>][_v] <span class="keyword">for</span> _v <span class="keyword">in</span> v} <span class="keyword">for</span> k, v <span class="keyword">in</span> key_selection.items()}</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        ret = <span class="string">"Error encountered while fetching weather data!\n"</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 特定的用str函数转换为字符串类型</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(ret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成随机数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_random_number</span>(<span class="params">min_v, max_v</span>):</span><br><span class="line">    <span class="comment"># 判断一下类型是不是小数、整数</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(min_v, (<span class="built_in">int</span>, <span class="built_in">float</span>)):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"min_v must be an integer"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(max_v, (<span class="built_in">int</span>, <span class="built_in">float</span>)):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"max_v must be an integer"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(random.randint(min_v, max_v))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义函数</span></span><br><span class="line">system_tool_description = {</span><br><span class="line">    <span class="string">'content'</span>: <span class="string">'Answer the following questions as best as you can. You have access to the following tools:'</span>,</span><br><span class="line">    <span class="string">'role'</span>: <span class="string">'system'</span>,</span><br><span class="line">    <span class="string">'tools'</span>: [{<span class="string">'description'</span>: <span class="string">'查询对应城市的天气'</span>,</span><br><span class="line">             <span class="string">'name'</span>: <span class="string">'get_weather'</span>,</span><br><span class="line">             <span class="string">'parameters'</span>: {<span class="string">'properties'</span>: {<span class="string">'city'</span>: {<span class="string">'description'</span>: <span class="string">'需要查询天气的城市'</span>}},</span><br><span class="line">                            <span class="string">'required'</span>: [],</span><br><span class="line">                            <span class="string">'type'</span>: <span class="string">'object'</span>}},</span><br><span class="line">            {<span class="string">'description'</span>: <span class="string">'生成随机数'</span>,</span><br><span class="line">             <span class="string">'name'</span>: <span class="string">'generate_random_number'</span>,</span><br><span class="line">             <span class="string">'parameters'</span>: {<span class="string">'properties'</span>: {<span class="string">'min_v'</span>: {<span class="string">'description'</span>: <span class="string">'最小值'</span>},</span><br><span class="line">                                           <span class="string">'max_v'</span>: {<span class="string">'description'</span>: <span class="string">'最大值'</span>}},</span><br><span class="line">                            <span class="string">'required'</span>: [],</span><br><span class="line">                            <span class="string">'type'</span>: <span class="string">'object'</span>}}</span><br><span class="line">            ]</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line"><span class="comment"># 函数以字典的形式保存，方便去使用字符串名称去调取函数它本身</span></span><br><span class="line"><span class="comment"># 比如 function_mapping["get_weather"] 就和 get_weather 是一样的</span></span><br><span class="line">function_mapping = {</span><br><span class="line">    <span class="string">'get_weather'</span>: get_weather,</span><br><span class="line">    <span class="string">'generate_random_number'</span>: generate_random_number,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">function_call</span>(<span class="params">response</span>):</span><br><span class="line">    function_name = response[<span class="string">'name'</span>]</span><br><span class="line">    parameters = response[<span class="string">'parameters'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 调用相应的函数</span></span><br><span class="line">    <span class="keyword">if</span> function_name <span class="keyword">in</span> function_mapping:</span><br><span class="line">        <span class="comment"># function_mapping[function_name]就找到对应的函数本身</span></span><br><span class="line">        <span class="comment"># **parameters解开字典</span></span><br><span class="line">        <span class="comment">#   {"city": "上海"} -&gt; city="上海"</span></span><br><span class="line">        <span class="comment"># result = get_weather(city="上海")</span></span><br><span class="line">        result = function_mapping[function_name](**parameters)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span>(<span class="string">"Function '{function_name}' not found."</span>.<span class="built_in">format</span>(function_name))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 模型的路径</span></span><br><span class="line">    MODEL_PATH = os.environ.get(<span class="string">"MODEL_PATH"</span>)</span><br><span class="line">    TOKENIZER_PATH = os.environ.get(<span class="string">"TOKENIZER_PATH"</span>, MODEL_PATH)</span><br><span class="line">    <span class="comment"># 加载模型</span></span><br><span class="line">    model = AutoModel.from_pretrained(MODEL_PATH, trust_remote_code=<span class="literal">True</span>, device_map=<span class="string">"auto"</span>).<span class="built_in">eval</span>()</span><br><span class="line">    <span class="comment"># 加载模型和token模型</span></span><br><span class="line">    tokenizer = AutoTokenizer.from_pretrained(TOKENIZER_PATH, trust_remote_code=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    past_key_values, history = <span class="literal">None</span>, [system_tool_description]</span><br><span class="line">    <span class="comment"># 获取用户的输入</span></span><br><span class="line">    query = <span class="built_in">input</span>(<span class="string">"\n用户："</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\nChatGLM："</span>, end=<span class="string">""</span>)</span><br><span class="line">    <span class="comment"># ============= 第一步：以role: user的身份去问问题</span></span><br><span class="line">    <span class="comment"># 模型通过问题的描述确定具体需要调用哪个函数和参数是什么</span></span><br><span class="line">    response, history = model.chat(tokenizer, query, history=history, role=<span class="string">"user"</span>)</span><br><span class="line">    <span class="built_in">print</span>(response, end=<span class="string">""</span>, flush=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 在python中去执行函数并返回结果</span></span><br><span class="line">    result = function_call(response)</span><br><span class="line">    <span class="comment"># ============= 第二步：以role: observation的身份去提供外部function call的答案</span></span><br><span class="line">    <span class="comment"># 程序将答案进行语言的组织返回结果</span></span><br><span class="line">    response, history = model.chat(tokenizer, result, history=history, role=<span class="string">"observation"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\nChatGLM："</span>, end=<span class="string">""</span>)</span><br><span class="line">    <span class="built_in">print</span>(response, end=<span class="string">""</span>, flush=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br></pre></td></tr></tbody></table></figure>
<p>把代码保存为文件比如<code>test_tool.py</code>执行代码（在之前需要<code>export MODEL_PATH=...</code>），得到的结果为：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">用户：上海天气</span><br><span class="line"></span><br><span class="line">ChatGLM：{'name': 'get_weather', 'parameters': {'city': '上海'}}</span><br><span class="line"></span><br><span class="line">ChatGLM：根据您的查询，我已经获取了上海的天气信息。目前上海的天气状况为：晴朗，当前温度为32摄氏度，湿度为63%，体感温度为34摄氏度。这些信息是从我们可信赖的天气API中获取的，并且这些数据是在09:06 AM时更新的。</span><br></pre></td></tr></tbody></table></figure>
<p>也可以问问生成随机数，比如说生成1-20的随机数。</p>
<p>到这里其实应该也明白了，原来工具调用也是<mark class="hl-label purple">一种特殊的prompt</mark> 啊！</p>
<h2 id="逐步执行">逐步执行</h2>
<p>其他代码不变，额外增加几个函数，将<code>__main__:</code>中的代码做了更改，这里不使用模型自己定义的<code>chat</code>方法，而是使用更为底层的<code>generate</code>方法，因为需要做特殊标记和文本的token id的组合写的比较啰嗦。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> copy <span class="keyword">import</span> deepcopy</span><br><span class="line"><span class="keyword">from</span> transformers.generation.logits_process <span class="keyword">import</span> LogitsProcessor</span><br><span class="line"><span class="keyword">from</span> transformers.generation.utils <span class="keyword">import</span> LogitsProcessorList</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InvalidScoreLogitsProcessor</span>(<span class="title class_ inherited__">LogitsProcessor</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, input_ids: torch.LongTensor, scores: torch.FloatTensor</span>) -&gt; torch.FloatTensor:</span><br><span class="line">        <span class="keyword">if</span> torch.isnan(scores).<span class="built_in">any</span>() <span class="keyword">or</span> torch.isinf(scores).<span class="built_in">any</span>():</span><br><span class="line">            scores.zero_()</span><br><span class="line">            scores[..., <span class="number">5</span>] = <span class="number">5e4</span></span><br><span class="line">        <span class="keyword">return</span> scores</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_tool_call</span>(<span class="params">response, history</span>):</span><br><span class="line">    history = deepcopy(history)</span><br><span class="line">    response = response.split(<span class="string">"&lt;|assistant|&gt;"</span>)[-<span class="number">1</span>]</span><br><span class="line">    metadata, content = response.split(<span class="string">"\n"</span>, maxsplit=<span class="number">1</span>)</span><br><span class="line">    history.append({<span class="string">"role"</span>: <span class="string">"assistant"</span>, <span class="string">"metadata"</span>: metadata, <span class="string">"content"</span>: content})</span><br><span class="line">    <span class="keyword">if</span> history[<span class="number">0</span>][<span class="string">"role"</span>] == <span class="string">"system"</span> <span class="keyword">and</span> <span class="string">"tools"</span> <span class="keyword">in</span> history[<span class="number">0</span>]:</span><br><span class="line">        content = <span class="string">"\n"</span>.join(content.split(<span class="string">"\n"</span>)[<span class="number">1</span>:-<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">tool_call</span>(<span class="params">**kwargs</span>):</span><br><span class="line">            <span class="keyword">return</span> kwargs</span><br><span class="line">        parameters = <span class="built_in">eval</span>(content)</span><br><span class="line">        content = {<span class="string">"name"</span>: metadata.strip(), <span class="string">"parameters"</span>: parameters}</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        content = {<span class="string">"name"</span>: metadata.strip(), <span class="string">"content"</span>: content}</span><br><span class="line">    <span class="keyword">return</span> content, history</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 模型的路径</span></span><br><span class="line">    MODEL_PATH = os.environ.get(<span class="string">"MODEL_PATH"</span>)</span><br><span class="line">    TOKENIZER_PATH = os.environ.get(<span class="string">"TOKENIZER_PATH"</span>, MODEL_PATH)</span><br><span class="line">    <span class="comment"># 加载模型和token模型</span></span><br><span class="line">    tokenizer = AutoTokenizer.from_pretrained(TOKENIZER_PATH, trust_remote_code=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加载模型</span></span><br><span class="line">    model = AutoModel.from_pretrained(MODEL_PATH, trust_remote_code=<span class="literal">True</span>, device_map=<span class="string">"auto"</span>).<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置generate方法的参数</span></span><br><span class="line">    logits_processor = LogitsProcessorList()</span><br><span class="line">    logits_processor.append(InvalidScoreLogitsProcessor())</span><br><span class="line">    gen_kwargs = {<span class="string">"max_length"</span>: <span class="number">8192</span>, <span class="string">"num_beams"</span>: <span class="number">1</span>, <span class="string">"do_sample"</span>: <span class="literal">True</span>, <span class="string">"top_p"</span>: <span class="number">0.8</span>,</span><br><span class="line">                  <span class="string">"temperature"</span>: <span class="number">0.8</span>, <span class="string">"logits_processor"</span>: logits_processor}</span><br><span class="line">    </span><br><span class="line">    query = <span class="built_in">input</span>(<span class="string">"\n用户："</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\nChatGLM："</span>, end=<span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用来保存</span></span><br><span class="line">    input_token_ids = <span class="built_in">list</span>()</span><br><span class="line">    history = [system_tool_description]</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> history:</span><br><span class="line">        content = item[<span class="string">"content"</span>]</span><br><span class="line">        <span class="keyword">if</span> item[<span class="string">"role"</span>] == <span class="string">"system"</span> <span class="keyword">and</span> <span class="string">"tools"</span> <span class="keyword">in</span> item:</span><br><span class="line">            <span class="comment"># 将上面定义的函数的描述转换为</span></span><br><span class="line">            content = content + <span class="string">"\n"</span> + json.dumps(item[<span class="string">"tools"</span>], indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        input_token_ids.append(tokenizer.get_command(<span class="string">"&lt;|{role}|&gt;"</span>.<span class="built_in">format</span>(role=item[<span class="string">"role"</span>])))</span><br><span class="line">        input_token_ids.extend(tokenizer.encode(content))</span><br><span class="line">    <span class="comment"># 添加query的token id</span></span><br><span class="line">    input_token_ids.append(tokenizer.get_command(<span class="string">"&lt;|{role}|&gt;"</span>.<span class="built_in">format</span>(role=<span class="string">"user"</span>)))</span><br><span class="line">    input_token_ids.extend(tokenizer.encode(query))</span><br><span class="line">    <span class="comment"># 最后再添加一个标记，表示需要你模型给信息了</span></span><br><span class="line">    input_token_ids.append(tokenizer.get_command(<span class="string">"&lt;|{role}|&gt;"</span>.<span class="built_in">format</span>(role=<span class="string">"assistant"</span>)))</span><br><span class="line">    <span class="comment"># 固定写法</span></span><br><span class="line">    inputs = tokenizer.batch_encode_plus([input_token_ids], return_tensors=<span class="string">"pt"</span>, is_split_into_words=<span class="literal">True</span>)</span><br><span class="line">    inputs = inputs.to(model.device)</span><br><span class="line">    <span class="comment"># 结束符号的标志</span></span><br><span class="line">    eos_token_id = [tokenizer.eos_token_id, tokenizer.get_command(<span class="string">"&lt;|user|&gt;"</span>),</span><br><span class="line">                    tokenizer.get_command(<span class="string">"&lt;|observation|&gt;"</span>)]</span><br><span class="line">    <span class="comment"># 使用最为基本的generate生成输出的文本的token id</span></span><br><span class="line">    outputs = model.generate(**inputs, **gen_kwargs, eos_token_id=eos_token_id)</span><br><span class="line">    outputs = outputs.tolist()[<span class="number">0</span>][<span class="built_in">len</span>(inputs[<span class="string">"input_ids"</span>][<span class="number">0</span>]):-<span class="number">1</span>]</span><br><span class="line">    <span class="comment"># 将token id转换为文本</span></span><br><span class="line">    response = tokenizer.decode(outputs)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"====&gt; "</span>, response)</span><br><span class="line"></span><br><span class="line">    response, history = parse_tool_call(response, history)</span><br><span class="line">    <span class="comment"># 在python中去执行函数并返回结果</span></span><br><span class="line">    result = function_call(response)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"====&gt; "</span>, result)</span><br><span class="line">    <span class="comment"># ============= 第二步：以role: observation的身份去提供外部function call的答案</span></span><br><span class="line">    <span class="comment"># 下面的代码和上面一样，除了role="observation"，query=result</span></span><br><span class="line">    <span class="comment"># 程序将答案进行语言的组织返回结果</span></span><br><span class="line">    input_token_ids = <span class="built_in">list</span>()</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> history:</span><br><span class="line">        content = item[<span class="string">"content"</span>]</span><br><span class="line">        <span class="keyword">if</span> item[<span class="string">"role"</span>] == <span class="string">"system"</span> <span class="keyword">and</span> <span class="string">"tools"</span> <span class="keyword">in</span> item:</span><br><span class="line">            <span class="comment"># 将上面定义的函数的描述转换为</span></span><br><span class="line">            content = content + <span class="string">"\n"</span> + json.dumps(item[<span class="string">"tools"</span>], indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        input_token_ids.append(tokenizer.get_command(<span class="string">"&lt;|{role}|&gt;"</span>.<span class="built_in">format</span>(role=item[<span class="string">"role"</span>])))</span><br><span class="line">        input_token_ids.extend(tokenizer.encode(content))</span><br><span class="line">    <span class="comment"># 添加query的token id</span></span><br><span class="line">    input_token_ids.append(tokenizer.get_command(<span class="string">"&lt;|{role}|&gt;"</span>.<span class="built_in">format</span>(role=<span class="string">"observation"</span>)))</span><br><span class="line">    <span class="comment"># 这里给出function call的结果</span></span><br><span class="line">    input_token_ids.extend(tokenizer.encode(result))</span><br><span class="line">    <span class="comment"># 最后再添加一个标记，表示需要你模型给信息了</span></span><br><span class="line">    input_token_ids.append(tokenizer.get_command(<span class="string">"&lt;|{role}|&gt;"</span>.<span class="built_in">format</span>(role=<span class="string">"assistant"</span>)))</span><br><span class="line">    <span class="comment"># 固定写法</span></span><br><span class="line">    inputs = tokenizer.batch_encode_plus([input_token_ids], return_tensors=<span class="string">"pt"</span>, is_split_into_words=<span class="literal">True</span>)</span><br><span class="line">    inputs = inputs.to(model.device)</span><br><span class="line">    <span class="comment"># 结束符号的标志</span></span><br><span class="line">    eos_token_id = [tokenizer.eos_token_id, tokenizer.get_command(<span class="string">"&lt;|user|&gt;"</span>),</span><br><span class="line">                    tokenizer.get_command(<span class="string">"&lt;|observation|&gt;"</span>)]</span><br><span class="line">    <span class="comment"># 使用最为基本的generate生成输出的文本的token id</span></span><br><span class="line">    outputs = model.generate(**inputs, **gen_kwargs, eos_token_id=eos_token_id)</span><br><span class="line">    outputs = outputs.tolist()[<span class="number">0</span>][<span class="built_in">len</span>(inputs[<span class="string">"input_ids"</span>][<span class="number">0</span>]):-<span class="number">1</span>]</span><br><span class="line">    <span class="comment"># 将token id转换为文本</span></span><br><span class="line">    response = tokenizer.decode(outputs)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\nChatGLM："</span>, end=<span class="string">""</span>)</span><br><span class="line">    <span class="built_in">print</span>(response, end=<span class="string">""</span>, flush=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br></pre></td></tr></tbody></table></figure>
<p>这里思维链为：</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;|system|&gt; Answer the following questions as best as you can. You have access to the following tools:</span><br><span class="line"></span><br><span class="line">[{'description': '查询对应城市的天气',</span><br><span class="line">  'name': 'get_weather',</span><br><span class="line">  ...</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">&lt;|user|&gt; 上海天气</span><br><span class="line"></span><br><span class="line">&lt;|assistant|&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>模型思考之后得到需要调用的函数以及对应的参数：</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;|assistant|&gt; get_weather</span><br><span class="line">tool_call(city='上海')</span><br></pre></td></tr></tbody></table></figure>
<p>执行函数之后，模型将结果进行整合：</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;|observation|&gt; </span><br><span class="line">{'current_condition': {'temp_C': '30', 'FeelsLikeC': '42', 'humidity': '79', 'weatherDesc': [{'value': 'Sunny'}], 'observation_time': '03:24 AM'}}</span><br><span class="line"></span><br><span class="line">&lt;|assistant|&gt; </span><br><span class="line">您好，根据您的查询，我已经帮您获取到了上海的天气信息。目前上海的天气状况是晴朗，温度为30摄氏度，湿度为79%，体感温度为42摄氏度。这个天气状况是从API中获取到的，并且API的观测时间是今天早上3点24分。</span><br></pre></td></tr></tbody></table></figure>
<h2 id="简化函数描述定义">简化函数描述定义</h2>
<p>在<code>composite_demo</code>文件夹下<code>tool_registry.py</code>，有一个比较方便的对函数进行注册的装饰器<code>register_tool</code>，不用自己去详细去写json去描述函数和参数，只需要在事先把注释写好：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@register_tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_weather</span>(<span class="params"></span></span><br><span class="line"><span class="params">        city_name: Annotated[<span class="built_in">str</span>, <span class="string">'城市的名称'</span>, <span class="literal">True</span>],</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取对应城市的天气</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(city_name, <span class="built_in">str</span>):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"City name must be a string"</span>)</span><br><span class="line"></span><br><span class="line">    key_selection = {</span><br><span class="line">        <span class="string">"current_condition"</span>: [<span class="string">"temp_C"</span>, <span class="string">"FeelsLikeC"</span>, <span class="string">"humidity"</span>, <span class="string">"weatherDesc"</span>, <span class="string">"observation_time"</span>],</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">import</span> requests</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        resp = requests.get(<span class="string">f"https://wttr.in/<span class="subst">{city_name}</span>?format=j1"</span>)</span><br><span class="line">        resp.raise_for_status()</span><br><span class="line">        resp = resp.json()</span><br><span class="line">        ret = {k: {_v: resp[k][<span class="number">0</span>][_v] <span class="keyword">for</span> _v <span class="keyword">in</span> v} <span class="keyword">for</span> k, v <span class="keyword">in</span> key_selection.items()}</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        ret = <span class="string">"Error encountered while fetching weather data!\n"</span> + traceback.format_exc()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(ret)</span><br></pre></td></tr></tbody></table></figure>
<p>原理和之前说的一样，这里利用了python的技巧，会更加的方便，后续将会使用这种方式来进行function call。</p>
<h2 id="已有的工具调用场景">已有的工具调用场景</h2>
<p>关于工具调用，目前已经有一些初期的案例：</p>
<p><img src="/posts/91e29fb3/%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8.jpg" alt="工具调用"></p>
<p>国内也有一些使用流的Agent构建：</p>
<p>比如百度的<a target="_blank" rel="noopener" href="https://agents.baidu.com/agent">baiduAgent</a>，有点门槛，会玩的还是挺方便：</p>
<p><img src="/posts/91e29fb3/%E7%99%BE%E5%BA%A6%E4%BD%8E%E4%BB%A3%E7%A0%81Agent.jpg" alt="百度低代码Agent"></p>
<p>还有一个说是零代码Agent，我感觉这不算Agent，只能说是特殊的Prompt：</p>
<p><img src="/posts/91e29fb3/%E7%99%BE%E5%BA%A6%E9%9B%B6%E4%BB%A3%E7%A0%81Agent.jpg" alt="百度零代码Agent"></p>
<p>还有字节的<a target="_blank" rel="noopener" href="https://www.coze.cn/">扣子</a>，感觉和百度这个差不多？</p>
<p><img src="/posts/91e29fb3/%E6%89%A3%E5%AD%90Agent.jpg" alt="扣子Agent"></p>
<p>感觉国内发展的还是挺快的，虽然这些工具看起来不太精细。</p>
<h2 id="LangChain对于ChatGLM3工具调用的支持">LangChain对于ChatGLM3工具调用的支持</h2>
<p>LangChain库对工具调用是进行了封装的，但它不能很好的支持<code>ChatGLM3</code>工具调用，需要添加额外的代码才行，最刚开始我看官方文档的时候不太能懂是在干什么，特别是role变来变去的，即便是我按照官方文档下来，后面万一需要个性化的处理我可能就懵逼了，所以这就促使我去了解是如何实现的。这样一个过程下来，后面就算更换为其他大语言模型也能游刃有余。如果一上来就按照LangChain的做法会很容易迷失在源码的海洋中，这种效率会非常低。</p>
<p>在官方文档中有具体的例子，后续在整理到这里。</p>
<h2 id="参考">参考</h2>
<p><a target="_blank" rel="noopener" href="https://zhipu-ai.feishu.cn/wiki/RYsHwIp6siQ0lgkVX3scfybNnld">官方文档 - 工具调用</a></p>
<p><a target="_blank" rel="noopener" href="http://it.sohu.com/a/743350350_121779701">AI Agent行业报告：框架拆解、应用方向、应用领域及相关公司深度梳理 </a></p>
<p>图片改编自：</p>
<p><a target="_blank" rel="noopener" href="https://ai.gopubby.com/llm-beyond-its-core-capabilities-as-ai-assistants-or-agents-704ffb972934">LLM Beyond its Core Capabilities as AI Assistants or Agents</a></p>
<p><a target="_blank" rel="noopener" href="https://gradientflow.substack.com/p/expanding-ai-horizons-the-rise-of">Expanding AI Horizons: The Rise of Function Calling in LLMs</a></p>
<script src="https://giscus.app/client.js" data-repo="eternal-bug/giscus" data-repo-id="R_kgDOMHOH6Q" data-category="Announcements" data-category-id="DIC_kwDOMHOH6c4Cf-m4" data-mapping="url" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async="">
</script></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://eternal-bug.github.io">eternal-bug</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://eternal-bug.github.io/posts/91e29fb3.html">https://eternal-bug.github.io/posts/91e29fb3.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://eternal-bug.github.io" target="_blank">eternal-bug的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/LangChain/">LangChain</a><a class="post-meta__tags" href="/tags/ChatGLM3/">ChatGLM3</a><a class="post-meta__tags" href="/tags/Agent/">Agent</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/weixin_reward.png" target="_blank"><img class="post-qr-code-img" src="/img/weixin_reward.png" alt="微信打赏"/></a><div class="post-qr-code-desc">微信打赏</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/25a848be.html" title="LangChain的拆解（一）利用符号重载实现基本Chain"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">LangChain的拆解（一）利用符号重载实现基本Chain</div></div></a></div><div class="next-post pull-right"><a href="/posts/67e74819.html" title="过度封装的LangChain？一个小白的吐槽"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">过度封装的LangChain？一个小白的吐槽</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/10f93d59.html" title="LangChain + 本地ChatGLM3模型构建RAG应用1：法律助手"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-21</div><div class="title">LangChain + 本地ChatGLM3模型构建RAG应用1：法律助手</div></div></a></div><div><a href="/posts/ae6567a8.html" title="LangChain + 本地ChatGLM3模型构建一条简单Chain"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-19</div><div class="title">LangChain + 本地ChatGLM3模型构建一条简单Chain</div></div></a></div><div><a href="/posts/67e74819.html" title="过度封装的LangChain？一个小白的吐槽"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-23</div><div class="title">过度封装的LangChain？一个小白的吐槽</div></div></a></div><div><a href="/posts/25a848be.html" title="LangChain的拆解（一）利用符号重载实现基本Chain"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-02</div><div class="title">LangChain的拆解（一）利用符号重载实现基本Chain</div></div></a></div><div><a href="/posts/e4f5c24f.html" title="清华智谱Chat-glm4模型服务器本地部署"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-15</div><div class="title">清华智谱Chat-glm4模型服务器本地部署</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">eternal-bug</div><div class="author-info__description">一个喜欢牵着骆驼、带着闪亮R形状戒指的白菜哥。</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/eternal-bug"><i class="fab fa-github"></i><span>关注我</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Agent%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.</span> <span class="toc-text">Agent是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E5%99%A8"><span class="toc-number">2.</span> <span class="toc-text">计算器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%9C%AC%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">3.</span> <span class="toc-text">文本是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%BD%E4%B8%9D%E5%89%A5%E8%8C%A7"><span class="toc-number">4.</span> <span class="toc-text">抽丝剥茧</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%90%E6%AD%A5%E6%89%A7%E8%A1%8C"><span class="toc-number">5.</span> <span class="toc-text">逐步执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8C%96%E5%87%BD%E6%95%B0%E6%8F%8F%E8%BF%B0%E5%AE%9A%E4%B9%89"><span class="toc-number">6.</span> <span class="toc-text">简化函数描述定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%B2%E6%9C%89%E7%9A%84%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">7.</span> <span class="toc-text">已有的工具调用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LangChain%E5%AF%B9%E4%BA%8EChatGLM3%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">8.</span> <span class="toc-text">LangChain对于ChatGLM3工具调用的支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">9.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/d2eaa30e.html" title="bash脚本中conda环境的转换">bash脚本中conda环境的转换</a><time datetime="2024-07-17T12:32:19.576Z" title="发表于 2024-07-17 20:32:19">2024-07-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/25a848be.html" title="LangChain的拆解（一）利用符号重载实现基本Chain">LangChain的拆解（一）利用符号重载实现基本Chain</a><time datetime="2024-07-02T11:53:32.000Z" title="发表于 2024-07-02 19:53:32">2024-07-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/91e29fb3.html" title="LangChain + 本地ChatGLM3模型构建Agent（一）工具调用的底层逻辑和测试">LangChain + 本地ChatGLM3模型构建Agent（一）工具调用的底层逻辑和测试</a><time datetime="2024-06-25T13:06:07.000Z" title="发表于 2024-06-25 21:06:07">2024-06-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/67e74819.html" title="过度封装的LangChain？一个小白的吐槽">过度封装的LangChain？一个小白的吐槽</a><time datetime="2024-06-23T03:21:47.000Z" title="发表于 2024-06-23 11:21:47">2024-06-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/10f93d59.html" title="LangChain + 本地ChatGLM3模型构建RAG应用1：法律助手">LangChain + 本地ChatGLM3模型构建RAG应用1：法律助手</a><time datetime="2024-06-21T13:23:56.000Z" title="发表于 2024-06-21 21:23:56">2024-06-21</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/starbound.half.png')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By eternal-bug</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">你好！欢迎来到<a href="https://eternal-bug.github.io">我的博客</a>。</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>